# 06. 다양한 연관관계 매핑

> 💂🏿‍♂️ 이 글은 김영한님의 ['자바 ORM 표준 JPA 프로그래밍'](https://www.inflearn.com/course/ORM-JPA-Basic)을 공부하며 정리한 것임을 알립니다.

<br>

## 6.1 다대일

* 데이터베이스 테이블의 일(1), 다(N) 관계에서 외래 키는 항상 다쪽에 존재  
  따라서 객체 양방향 관계에서 연관관계의 주인은 항상 다쪽

### 6.1.1 다대일 단방향 [N:1]

* 다대일 단방향에서 두 객체 중 하나의 객체만 참조가 가능

### 6.1.2 다대일 양방향 [N:1 , 1:N]

* 양방향은 외래 키가 있는 쪽이 연관관계의 주인
  * JPA는 외래 키를 관리할 때 연관관계의 주인만 사용
  * 주인이 아닌 쪽은 조회를 위한 JPQL 혹은 객체 그래프를 탐색할 때 사용
* 양방향 연관관계는 항상 서로를 참조
  * 어느 한 쪽만 참조하게 된다면 양방향 연관관계가 성립 X
  * 따라서 연관관계의 편의 메소드(Setter, addMethod)를 작성하는 것이 좋음  
    만약 양쪽 모두 편의 메소드를 작성한다면 무한 루프에 걸릴 수 있음

<br>

## 6.2 일대다

* 다대일 관계의 반대 방향
* 일대다 관계는 엔티티 하나 이상을 참조할 수 있으므로 컬렉션(List, Set, Map)중 하나 선택해서 사용

### 6.2.1 일대다 단방향 [1:N]

* 일대다 단방향 관계는 JPA 2.0부터 지원
* 반대쪽 테이블에 있는 외래 키를 관리
* `@JoinColumn`을 명시  
  그렇지 않으면 JPA에서 연결 테이블을 중간에 두고 연관관계를 관리하는 조인 테이블 전략을 기본으로 사용하여 매핑
* 반대쪽 테이블에 있는 외래 키를 관리하기 때문에 추가적인 SQL 쿼리가 필요
* 일대다 단방향 매핑보다는 다대일 양방향 매핑을 사용하는것을 권장

### 6.2.2 일대다 양방향 [1:N, N:1]

* 일대다 양방향 매핑은 존재 X , 대신 다대일 양방향 매핑을 사용
* 더 정확하게 보자면 양방향 매핑에서 `@OneToMany`는 연관관계의 주인이 될 수 없음  
  `@ManyToOne` 에는 `mappedBy` 속성이 없음
* 완전히 불가능한 것은 아님  
  일대다 단방향 매핑 반대편에 같은 외래 키를 사용하는 다대일 단방향 매핑을 읽기 전용으로 하나 추가하면 됨  
  하지만 일대다 단방향 매핑의 단점을 그대로 가지므로 사용하지 않는 것이 좋음

<br>

## 6.3 일대일 [1:1]

* 양쪽이 하나의 관계만 가지고 있는 매핑으로 주 테이블 혹은 대상 테이블 둘 중 어느 곳이나 외래 키를 가질 수 있음  
  따라서 누가 외래 키를 가질지 선택
  * 주 테이블에 외래 키
    * 외래 키를 객체 참조와 비슷하게 사용이 가능
    * 주 테이블만 확인해도 대상 테이블과 연관관계가 있는지 확인 가능
  * 대상 테이블에 외래 키
    * 테이블 관계를 일대일에서 일대다로 변경할 때 테이블 구조를 그대로 가져감

### 6.3.1 주 테이블에 외래 키

* 외래 키를 객체 참조와 비슷하게 사용이 가능
* 주 테이블만 확인해도 대상 테이블과 연관관계가 있는지 확인 가능
* JPA도 주 테이블에 외래 키가 있으면 좀 더 편리하게 매핑
* 양방향 관계일 때는 `mappedBy` 속성을 이용하여 연관관계의 주인을 선택

### 6.3.2 대상 테이블에 외래 키

* 대상 테이블에 외래 키가 있는 단방향 관게는 JPA에서 지원 X
* 양방향 관계로 만들고 대상 테이블을 연관관계의 주인으로 만들거나, 단방향 관계를 바꾸거나 둘 중 하나
* 프록시를 사용할 때 외래 키를 직접 관리하지 않는 일대일 관계는 지연 로딩을 설정해도 즉시 로딩  
  이는 프록시의 한계 때문에 발생하는 문제로 `bytecode instrumnetation`을 사용하면 해결

<br>

## 6.4 다대다 [N:N]

* 관계형 데이터베이스에서는 정규화된 테이블 2개로 다대다를 표현 X  
  따라서 중간에 연결 테이블을 추가
* 객체의 경우 2개의 객체로 다대다 관계를 만들 수 있음(`@ManyToMany`를 사용)

### 6.4.1 다대다 단방향

* `@ManyToMany` 와 `@JoinTable` 을 사용하여 중간에 연결 엔티티 없이 바로 매핑
* `@JoinTable`
  * name : 연결할 테이블 지정
  * joinColumns : 매핑할 조인 컬럼 정보 지정
  * inverseJoinColumns : 반대 방향의 테이블과 매핑할 조인 컬럼 정보 지정
* JPA에서 알아서 중간 테이블과 매핑하여 저장과 조회 등을 수행

### 6.4.2 다대다 양방향

* 똑같이 `@ManyToMany`를 사용하며 원하는 곳에 `mappedBy`로 연관관계의 주인을 설정
* 연관관계 편의 메소드를 추가하여 관리하는 것이 편리

### 6.4.3 매핑의 한계와 극복, 연결 엔티티 사용

* 보통 중간 연결 테이블에 외래 키 말도고 다른 컬럼들이 존재한다면 `@ManyToMany` 를 사용 X
* 따라서 중간 연결 엔티티를 만들어 추가한 컬럼들을 매핑하고 다대다를 일대다, 다대일 관계로 풀어야 함
* 보통 연결 테이블에서 외래 키를 가지고 있기 때문에 연결 테이블이 보통 연관관계의 주인
* `@Id` 와 `@JoinColumn` 을 동시에 사용하여 기본 키 + 외래 키를 한번에 매핑  
  `@IdClass`를 사용하여 복합 기본 키를 매핑
* JPA에서 복합 키를 사용하려면 별도의 식별자 클래스가 존재하야 함, 특징은 다음과 같음
  * Serializable을 구현
  * equals, hashCode 메소드 구현
  * 기본 생성자 존재
  * public
  * `@IdClass` 외에 `@EmbeddedId` 사용
* 연결 테이블은 부모 테이블의 기본 키를 받아 자신의 기본 키 + 외래 키로 사용하는데 이를 **식별 관계**라고 함
* 복합 키는 항상 식별자 클래스를 만들어야 하는데 이로 엔티티를 조회  
  따라서 사용하는 방법은 복잡

### 6.4.4 새로운 기본 키 사용

* 데이터베이스에서 자동으로 생성해주는 대리 키를 `Long` 값으로 사용하는 것을 추천  
  간단하며, 영구히 쓸 수 있고 비지니스에 의존 X, 복합 키 필요 X
* 식별자 클래스도 사용하지 않아도 되므로 코드도 한결 단순

### 6.4.5 정리

* 다대다 관게를 일대다 다대일로 풀어내기 위해 연결 테이블을 만들 때 식별자를 어떻게 구성할지 선택

  * 식별 관계

    > 받아온 식별자를 기본 키 + 외래 키로 사용

  * 비식별 관계

    > 받아온 식별자는 외래 키로만 사용하고 새로운 식별자 추가

